<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½æ±‰å­—ç¬”ç”»æçº¢ç”Ÿæˆå™¨ (å¸¦ç¬”é¡ºå¼•å¯¼ç‰ˆ)</title>
    <style>
        :root {
            --grid-color: #d81e06;
            --grid-size: 15mm;     /* 80%å¤§å° */
            --font-family: "KaiTi", "STKaiti", "æ¥·ä½“", "DFKaiShu-GB5", "AR PL UKai CN", "AR PL UKai",  serif;
        }

        body { margin: 0; padding: 0; background-color: #f5f5f5; font-family: sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            background: white; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 900px; margin: 20px auto; border-radius: 8px;
        }
        .controls h2 { margin-top: 0; color: #333; }
        
        .panel-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .category-title { font-size: 14px; color: #d81e06; font-weight: bold; margin: 10px 0 5px 0; }
        
        .stroke-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 6px; }
        .stroke-btn {
            background: #fff; border: 1px solid #ddd; border-radius: 4px;
            padding: 4px; cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .stroke-btn:hover { background: #eef; border-color: #aaf; transform: scale(1.05); }
        .stroke-btn span.s-char { display: block; font-family: var(--font-family); font-size: 22px; color: #333; height: 30px; line-height: 30px;}
        .stroke-btn span.s-name { display: block; font-size: 11px; color: #888; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; font-family: var(--font-family); font-size: 18px; }
        
        .action-bar { text-align: right; margin-top: 20px; position: sticky; bottom: 0; background: white; padding: 10px 0; border-top: 2px solid #eee; }
        button { padding: 10px 20px; font-size: 16px; border-radius: 4px; cursor: pointer; border: none; margin-left: 10px; }
        button.main { background-color: #2c3e50; color: white; }
        button.config { background-color: #e67e22; color: white; }
        button.print { background-color: #d81e06; color: white; }
        button.clear { background-color: white; border: 1px solid #ccc; color: #666; padding: 5px 10px; font-size: 12px;}

        /* --- æ¨¡æ€æ¡† (é…ç½®ç”¨) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal textarea { height: 200px; font-family: monospace; font-size: 12px; }

        /* --- A4 çº¸å¼  --- */
        .page {
            width: 210mm; min-height: 297mm; padding: 15mm 10mm; margin: 20px auto;
            background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative; display: flex; flex-direction: column; box-sizing: border-box;
        }
        .header {
            display: flex; justify-content: space-between; margin-bottom: 8mm;
            font-family: var(--font-family); border-bottom: 2px solid var(--grid-color);
        }
        .row { display: flex; margin-bottom: 3mm; gap: 2mm; justify-content: center; }
        
        .tianzige {
            width: var(--grid-size); height: var(--grid-size); border: 1px solid var(--grid-color);
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        /* ç”°å­—æ ¼è™šçº¿ */
        .tianzige::before {
            content: ''; position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed var(--grid-color); transform: translateY(-50%);
        }
        .tianzige::after {
            content: ''; position: absolute; left: 50%; top: 0; bottom: 0; border-left: 1px dashed var(--grid-color); transform: translateX(-50%);
        }

        /* ç‰¹æ®Šç±»ï¼šéšè—å†…éƒ¨è™šçº¿ï¼ˆç”¨äºç¬¬ä¸€ä¸ªç¬”é¡ºæ ¼ï¼‰ */
        .tianzige.no-grid::before, .tianzige.no-grid::after { display: none; }

        .char { font-family: var(--font-family); font-size: calc(var(--grid-size) * 0.75); z-index: 1; position: relative; }
        .black { color: #000; }
        .trace { 
             color: #000000; 
             opacity: 0.35; /* æçº¢æ·¡åŒ– */
        }

        /* ç¬”é¡º Canvas */
        .stroke-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none;
        }

        @media print {
            body { background: white; margin: 0; }
            .controls, .modal { display: none; }
            .page { margin: 0; box-shadow: none; page-break-after: always; height: 297mm; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>å…¨èƒ½ç¡¬ç¬”ä¹¦æ³•å­—å¸– (å¸¦ç¬”é¡ºå¼•å¯¼)</h2>

        <!-- ç¬”ç”»é€‰æ‹©é¢æ¿ -->
        <div class="panel-section">
            <label>ç¬”ç”»åº“ï¼ˆç‚¹å‡»æ·»åŠ åˆ°ä¸‹æ–¹ï¼‰ï¼š</label>
            <div class="category-title">ä¸€ã€åŸºç¡€ç¬”ç”»</div>
            <div class="stroke-grid" id="group-basic"></div>
            <div class="category-title">äºŒã€æŠ˜ç¬”ä¸é’©æ³•</div>
            <div class="stroke-grid" id="group-hook"></div>
            <div class="category-title">ä¸‰ã€å¤æ‚å¤åˆç¬”ç”»</div>
            <div class="stroke-grid" id="group-complex"></div>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div class="panel-section">
            <div style="display:flex; justify-content:space-between;">
                <label>æ¨¡å¼1ï¼šç¬”ç”» + èŒƒå­—</label>
                <button class="clear" onclick="document.getElementById('mode1Input').value=''">æ¸…ç©º</button>
            </div>
            <textarea id="mode1Input">ä¸¶,ä¸»
ä¸¨,ä¸­</textarea>
        </div>

        <div class="panel-section">
            <label>æ¨¡å¼2ï¼šæ•´å­—ç»ƒä¹ </label>
            <textarea id="mode2Input" placeholder="è¾“å…¥æ±‰å­—...">æ°¸å’Œä¹å¹´</textarea>
        </div>

        <div class="action-bar">
            <button class="config" onclick="openConfig()">ğŸ›  å¯¼å…¥ç¬”é¡ºé…ç½®</button>
            <button class="main" onclick="generate()">ç”Ÿæˆé¢„è§ˆ</button>
            <button class="print" onclick="window.print()">æ‰“å° / ä¿å­˜PDF</button>
        </div>
    </div>

    <!-- æ‰“å°åŒºåŸŸ -->
    <div id="print-area"></div>

    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h3>å¯¼å…¥ç¬”é¡ºæ•°æ®</h3>
            <p style="font-size:12px; color:#666">è¯·å°†â€œç¬”ç”»è½¨è¿¹å½•å…¥å·¥å…·â€ç”Ÿæˆçš„ä»£ç å®Œæ•´ç²˜è´´åˆ°ä¸‹æ–¹ï¼ˆconst strokePaths = ...ï¼‰ï¼š</p>
            <textarea id="configInput" placeholder="åœ¨æ­¤ç²˜è´´ const strokePaths = { ... };"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="clear" onclick="closeConfig()">å–æ¶ˆ</button>
                <button class="main" onclick="saveConfig()">ä¿å­˜å¹¶åº”ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        // å®Œæ•´çš„ Unicode CJK Strokes æ•°æ®
        const strokeData = {
            basic: [
                { name: "ç‚¹", char: "ä¸¶", ex: "ä¸»" }, { name: "æ¨ª", char: "ä¸€", ex: "ç‹" },
                { name: "ç«–", char: "ä¸¨", ex: "ä¸­" }, { name: "æ’‡", char: "ã‡’", ex: "é‡‘" },
                { name: "æº", char: "ã‡", ex: "å¤§" }, { name: "æ", char: "ã‡€", ex: "å†°" },
                { name: "ç«–æ’‡", char: "ä¸¿", ex: "æœˆ" }
            ],
            hook: [
                { name: "æ¨ªé’©", char: "ã‡–", ex: "ä¹°" }, { name: "æ¨ªæŠ˜é’©", char: "ã‡†", ex: "ç¾½" },
                { name: "ç«–é’©", char: "äº…", ex: "å°" }, { name: "ç«–æ", char: "ã‡™", ex: "é•¿" },
                { name: "å¼¯é’©", char: "ã‡", ex: "å®¶" }, { name: "å§é’©", char: "ã‡ƒ", ex: "å¿ƒ" },
                { name: "æ–œé’©", char: "ã‡‚", ex: "é£" }, { name: "ç«–å¼¯", char: "ã‡„", ex: "è¥¿" }
            ],
            complex: [
                { name: "ç«–å¼¯é’©", char: "ä¹š", ex: "ç¤¼" }, { name: "æ¨ªæŠ˜", char: "ã‡•", ex: "å£" },
                { name: "ç«–æŠ˜", char: "ã‡—", ex: "å±±" }, { name: "æ’‡æŠ˜", char: "ã‡œ", ex: "å»" },
                { name: "æ’‡ç‚¹", char: "ã‡›", ex: "å¥³" }, { name: "æ¨ªæŠ˜æ", char: "ã‡Š", ex: "è®¡" },
                { name: "æ¨ªæŠ˜å¼¯", char: "ã‡", ex: "æŠ•" }, { name: "æ¨ªæŠ˜å¼¯é’©", char: "ã‡ˆ", ex: "ä¹" },
                { name: "æ¨ªæ’‡å¼¯é’©", char: "ã‡Œ", ex: "é™ˆ" }, { name: "æ¨ªæŠ˜æŠ˜", char: "ã‡…", ex: "å‡¹" },
                { name: "æ¨ªæŠ˜æŠ˜æ’‡", char: "ã‡‹", ex: "åŠ" }, { name: "ç«–æŠ˜æŠ˜", char: "ã‡", ex: "é¼" },
                { name: "ç«–æŠ˜æŠ˜é’©", char: "ã‡‰", ex: "å¼“" }, { name: "æ¨ªæŠ˜æŠ˜æŠ˜", char: "ã‡", ex: "å‡¸" },
                { name: "æ¨ªæŠ˜æŠ˜æŠ˜é’©", char: "ã‡¡", ex: "ä¹ƒ" }
            ]
        };

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨åŠ è½½çš„ç¬”é¡ºæ•°æ®
        let loadedPaths = {};

        function initControls() {
            renderGroup('group-basic', strokeData.basic);
            renderGroup('group-hook', strokeData.hook);
            renderGroup('group-complex', strokeData.complex);
            
            // ä» LocalStorage åŠ è½½é…ç½®
            const saved = localStorage.getItem('strokePathsConfig');
            if (saved) {
                try {
                    loadedPaths = JSON.parse(saved);
                    console.log("ç¬”é¡ºé…ç½®å·²åŠ è½½");
                } catch(e) { console.error("é…ç½®åŠ è½½å¤±è´¥", e); }
            }
        }

        function renderGroup(id, list) {
            const container = document.getElementById(id);
            list.forEach(s => {
                const btn = document.createElement('div');
                btn.className = 'stroke-btn';
                btn.innerHTML = `<span class="s-char">${s.char}</span><span class="s-name">${s.name}</span>`;
                btn.onclick = () => addStroke(s.char, s.ex);
                container.appendChild(btn);
            });
        }

        function addStroke(char, ex) {
            const input = document.getElementById('mode1Input');
            const val = input.value;
            const prefix = (val === '' || val.endsWith('\n')) ? '' : '\n';
            input.value += `${prefix}${char},${ex}`;
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ›å»ºæ ¼å­ ---
        function createBox(text, type, isGuideMode = false) {
            const box = document.createElement('div');
            box.className = 'tianzige';
            
            // å¦‚æœæ˜¯ç¬”é¡ºå¼•å¯¼æ ¼ï¼ˆMode1çš„ç¬¬ä¸€ä¸ªï¼‰ï¼ŒåŠ ä¸Š no-grid ç±»ä»¥éšè—è™šçº¿
            if (isGuideMode) {
                box.classList.add('no-grid');
            }

            // 1. æ”¾å…¥æ–‡å­—
            if (text && text.trim()) {
                const span = document.createElement('span');
                span.className = `char ${type}`;
                span.textContent = text;
                box.appendChild(span);

                // 2. å¦‚æœæœ‰ç¬”é¡ºæ•°æ®ï¼Œä¸”æ˜¯å¼•å¯¼æ¨¡å¼ï¼Œç»˜åˆ¶Canvas
                if (isGuideMode && loadedPaths[text]) {
                    renderStrokeGuide(box, loadedPaths[text]);
                }
            }
            return box;
        }

// --- ä¿®æ”¹åçš„ç»˜åˆ¶å‡½æ•°ï¼šå»ç®­å¤´ï¼ŒåŠ èµ·ç¬”åœ†ç‚¹ ---
        function renderStrokeGuide(container, points) {
            const canvas = document.createElement('canvas');
            canvas.className = 'stroke-canvas';
            const size = 150; 
            canvas.width = size; 
            canvas.height = size;
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const lw = 4; // å®šä¹‰çº¿å®½

            // 1. ç»˜åˆ¶çº¢çº¿è½¨è¿¹
            ctx.beginPath();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = lw;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            points.forEach((p, i) => {
                const x = p[0] * size;
                const y = p[1] * size;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // 2. ç»˜åˆ¶èµ·ç¬”å®å¿ƒåœ†ç‚¹
            if (points.length > 0) {
                const start = points[0];
                const sx = start[0] * size;
                const sy = start[1] * size;

                ctx.beginPath();
                // åŠå¾„è®¾ä¸º lw (çº¿å®½)ï¼Œé‚£ä¹ˆç›´å¾„å°±æ˜¯ 2 * lw (ä¸¤å€çº¿å®½)
                ctx.arc(sx, sy, 2*lw, 0, Math.PI * 2);
                ctx.fillStyle = 'red';
                ctx.fill();
            }
        }
        // --- é…ç½®ç›¸å…³ ---
        function openConfig() { document.getElementById('configModal').style.display = 'flex'; }
        function closeConfig() { document.getElementById('configModal').style.display = 'none'; }
        
        function saveConfig() {
            let input = document.getElementById('configInput').value.trim();
            if (!input) return;

            // ç®€å•çš„æ¸…ç†ï¼šå»æ‰ const strokePaths = å’Œæœ€åçš„ ;
            // è¿™æ ·ç”¨æˆ·ç›´æ¥å…¨é€‰ç²˜è´´ä¹Ÿæ²¡äº‹
            input = input.replace(/const\s+\w+\s*=\s*/, '');
            input = input.replace(/;$/, '');

            try {
                const json = JSON.parse(input);
                loadedPaths = json;
                localStorage.setItem('strokePathsConfig', JSON.stringify(json));
                alert('é…ç½®ä¿å­˜æˆåŠŸï¼');
                closeConfig();
                generate(); // é‡æ–°ç”Ÿæˆé¢„è§ˆ
            } catch (e) {
                alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿ç²˜è´´çš„æ˜¯æ­£ç¡®çš„ JSON å†…å®¹ã€‚\n' + e.message);
            }
        }

        function generate() {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';
            
            const createNewPage = () => {
                const p = document.createElement('div');
                p.className = 'page';
                p.innerHTML = `
                    <div class="header">
                        <div>å§“åï¼š__________</div>
                        <div>æ—¥æœŸï¼š__________</div>
                        <div>è¯„åˆ†ï¼šâ˜†â˜†â˜†â˜†â˜†</div>
                    </div>`;
                return p;
            };

            let currentPage = createNewPage();
            printArea.appendChild(currentPage);
            let rows = 0;
            const limit = 13; 

            // --- æ¨¡å¼ 1 ---
            const m1Text = document.getElementById('mode1Input').value;
            m1Text.split('\n').forEach(line => {
                if(!line.trim()) return;
                const parts = line.replace('ï¼Œ', ',').split(',');
                if(parts.length < 2) return;

                if(rows >= limit) {
                    currentPage = createNewPage();
                    printArea.appendChild(currentPage);
                    rows = 0;
                }

                const s = parts[0].trim();
                const w = parts[1].trim()[0] || '';
                
                const div = document.createElement('div');
                div.className = 'row';
                
                // 1. å¼•å¯¼æ ¼ (é»‘è‰²èŒƒå­— + éšè—è™šçº¿ + çº¢è‰²ç®­å¤´)
                // ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•° true è¡¨ç¤ºè¿™æ˜¯å¼•å¯¼æ ¼
                div.appendChild(createBox(s, 'black', true));
                
                // 2. 5ä¸ªç°è‰²æçº¢ (ç¬”ç”»)
                for(let i=0; i<5; i++) div.appendChild(createBox(s, 'trace'));
                
                // 3. 3ä¸ªç°è‰²æçº¢ (æ±‰å­—)
                for(let i=0; i<3; i++) div.appendChild(createBox(w, 'trace'));
                
                currentPage.appendChild(div);
                rows++;
            });

            // --- æ¨¡å¼ 2 (ä¿æŒä¸å˜) ---
            const m2Text = document.getElementById('mode2Input').value;
            const chars = m2Text.split('').filter(c=>c.trim());
            chars.forEach(c => {
                if(rows >= limit) {
                    currentPage = createNewPage();
                    printArea.appendChild(currentPage);
                    rows = 0;
                }
                const div = document.createElement('div');
                div.className = 'row';
                div.appendChild(createBox(c, 'black'));
                for(let i=0; i<8; i++) div.appendChild(createBox(c, 'trace'));
                currentPage.appendChild(div);
                rows++;
            });
        }

        window.onload = () => {
            initControls();
            generate();
        };
    </script>
</body>
</html>