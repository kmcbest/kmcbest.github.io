<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fanfic Architect V3.1</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --card-bg: #262626;
            --input-bg: #333;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent: #4caf50; /* Green for Active */
            --highlight: #2196f3; /* Blue for focus/primary */
            --border: #444;
            --danger: #ff5252;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ÊªöÂä®Êù°ÁæéÂåñ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* --- Â∏ÉÂ±Ä --- */
        .container { display: flex; width: 100%; height: 100%; }
        .panel { padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .left-panel { flex: 1.3; border-right: 1px solid var(--border); }
        .right-panel { flex: 1; background-color: #181818; }

        h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--highlight); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: space-between; }

        /* --- ÈÄöÁî®Êéß‰ª∂ --- */
        input[type="text"], textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
            font-size: 0.9rem;
        }
        
        textarea:focus, input:focus { outline: 1px solid var(--highlight); border-color: var(--highlight); }

        .btn {
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn:hover { background-color: #444; }
        .btn-primary { background-color: var(--highlight); border-color: var(--highlight); color: white; }
        .btn-primary:hover { background-color: #1976d2; }
        .btn-add { width: 100%; border-style: dashed; color: #888; margin-top: 5px; }
        
        /* --- ËßíËâ≤Âç°Áâá --- */
        .char-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .char-card.inactive { opacity: 0.6; border-color: #333; }
        
        .char-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #2d2d2d;
            border-radius: 6px 6px 0 0;
            gap: 12px;
            user-select: none;
        }

        .char-toggle { transform: scale(1.2); cursor: pointer; accent-color: var(--accent); }

        .char-name-display {
            flex: 1;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-main);
        }

        .char-body {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            border-top: 1px solid var(--border);
        }
        .char-body.hidden { display: none; }

        /* Â≠óÊÆµÂùó */
        .field-block {
            background-color: #1a1a1a;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .field-block.full-width { grid-column: span 2; }
        
        .field-header { display: flex; align-items: center; gap: 8px; }
        .field-label { font-size: 0.75rem; color: var(--text-muted); font-weight: bold; cursor: pointer; flex:1; }
        .field-check { cursor: pointer; accent-color: var(--highlight); }
        
        .field-block.inactive textarea { opacity: 0.4; pointer-events: none; }
        .field-block.inactive .field-label { text-decoration: line-through; opacity: 0.5; }

        /* --- È¢ÑËßàÂå∫ --- */
        .preview-box {
            flex: 1;
            background-color: #111;
            border: 1px solid var(--border);
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            color: #ddd;
            overflow-y: auto;
            line-height: 1.5;
        }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #666; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <!-- Â∑¶‰æßÔºöÁºñËæëÂå∫ -->
    <div class="panel left-panel">
        
        <!-- 1. ÂÖ®Â±ÄÈÖçÁΩÆ -->
        <div>
            <h3>
                <span>üõ†Ô∏è Global Context</span>
                <span style="font-size:0.7rem; font-weight:normal; color:#666;">Checks include/exclude sections</span>
            </h3>
            <div style="display:flex; gap:15px; margin-bottom:12px;">
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                    <input type="checkbox" id="use-meta" checked> Internal Notes
                </label>
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                    <input type="checkbox" id="use-story" checked> Story So Far
                </label>
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                    <input type="checkbox" id="use-tone" checked> Tone & Rules
                </label>
            </div>
            <textarea id="meta-goal" placeholder="Goal & Theme..." rows="2"></textarea>
            <textarea id="story-so-far" placeholder="Story So Far (Key plot points)..." rows="3" style="margin-top:8px;"></textarea>
        </div>

        <!-- 2. ËßíËâ≤ÁÆ°ÁêÜ -->
        <div>
            <h3>
                <span>üë• Character Roster</span>
            </h3>
            <div id="char-container"></div>
            <button class="btn btn-add" onclick="addNewChar()">+ Add New Character</button>
        </div>

        <!-- 3. ÂΩìÂâçÂú∫ÊôØ -->
        <div>
            <h3>üé¨ Scene Beats (Required)</h3>
            <input type="text" id="task-overview" placeholder="Task Overview (e.g. Continue the training scene...)" style="margin-bottom:8px;">
            <textarea id="scene-beats" placeholder="- Beat 1&#10;- Beat 2..." rows="6"></textarea>
        </div>
        
        <!-- 4. Tone & Rules (ÂèØÊäòÂè†) -->
        <details open>
            <summary style="cursor:pointer; color:var(--highlight); font-weight:bold; font-size:0.9rem; margin-bottom:5px;">üé® TONE & ENDING INSTRUCTION</summary>
            <textarea id="tone-rules" rows="7" style="font-size:0.85rem; margin-top:5px;"></textarea>
            <label style="font-size:0.8rem; color:#888; margin-top:8px; display:block;">Ending Instruction:</label>
            <input type="text" id="end-instr" style="margin-top:2px;">
        </details>
    </div>

    <!-- Âè≥‰æßÔºöÈ¢ÑËßàÂå∫ -->
    <div class="panel right-panel">
        <div class="status-bar">
            <strong>PROMPT PREVIEW</strong>
            <span id="save-status">Ready</span>
        </div>
        <div class="preview-box" id="output"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="copyPrompt()">üìã Copy Prompt</button>
            <button class="btn" onclick="generatePrompt()">üîÑ Refresh</button>
            <button class="btn" onclick="clearBeats()" style="background-color:#333; color:#ff5252; margin-left:auto; border-color:#555;">üóëÔ∏è Clear Beats</button>
        </div>
    </div>
</div>

<script>
    // --- È¢ÑÂ°´ÂÜÖÂÆπÂ∏∏Èáè ---
    const PREFILL_TONE = `- Start IN MEDIAS RES with physical motion or dialogue.
- NO scenic opening, NO mood painting, NO weather/time-of-day prose.
- Focus on technique, tension, internal thought, relationship dynamics.
- Elegant writing, martial precision, emotional subtlety.
- Professional narrative prose, not pulp or melodrama.
- NO lyrical wrap-ups. NO thematic coda. Cut mid-moment, not resolved.`;

    const PREFILL_END = `End the passage as Lucia and Mika square up. Hard stop. No metaphor, no moral, no soft landing.`;

    // --- ËßíËâ≤Â≠óÊÆµÈÖçÁΩÆ ---
    const FIELDS_CONFIG = [
        { key: 'appearance', label: 'Appearance', rows: 2, full: false },
        { key: 'moves', label: 'Combat Style & Moves', rows: 3, full: true }, 
        { key: 'personality', label: 'Personality Traits', rows: 2, full: false },
        { key: 'dialogue', label: 'Dialogue Patterns', rows: 2, full: false },
        { key: 'bodyLang', label: 'Body Language & Subtleties', rows: 2, full: true },
        { key: 'background', label: 'Background & Values', rows: 2, full: false },
        { key: 'motivations', label: 'Key Motivations', rows: 2, full: false },
        { key: 'relationships', label: 'Relationships', rows: 2, full: true },
        { key: 'conflicts', label: 'Conflict & Contradiction', rows: 2, full: false },
        { key: 'sexual', label: 'Sexual Indicator/Dynamics', rows: 2, full: false }
    ];

    // --- Êï∞ÊçÆÁä∂ÊÄÅ ---
    let appData = {
        metaGoal: "",
        storySoFar: "",
        taskOverview: "",
        sceneBeats: "",
        toneRules: PREFILL_TONE, // ÈªòËÆ§‰ΩøÁî®‰Ω†ÁöÑÈ¢ÑÂ°´ÂÜÖÂÆπ
        endInstr: PREFILL_END,   // ÈªòËÆ§‰ΩøÁî®‰Ω†ÁöÑÈ¢ÑÂ°´ÂÜÖÂÆπ
        useMeta: true,
        useStory: true,
        useTone: true,
        characters: [] 
    };

    // --- ÂàùÂßãÂåñ ---
    window.onload = () => {
        loadData();
        
        // Â¶ÇÊûúÊ≤°ÊúâËßíËâ≤ÔºåÊ∑ªÂä†‰∏Ä‰∏™Á©∫ÁöÑÊñπ‰æøÂºÄÂßã
        if(appData.characters.length === 0) addNewChar();
        else renderCharList();

        generatePrompt();
        
        // ‰∫ã‰ª∂ÁõëÂê¨
        document.body.addEventListener('input', (e) => handleInput(e));
        document.body.addEventListener('change', (e) => handleInput(e));
    };

    function handleInput(e) {
        if(e.target.closest('.char-card')) {
            updateCharData(e.target);
        } else {
            if(appData.hasOwnProperty(e.target.id)) {
                appData[e.target.id] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
            }
        }
        saveData();
        generatePrompt();
    }

    // --- ËßíËâ≤ÈÄªËæë ---
    function addNewChar() {
        const newChar = {
            id: Date.now(),
            name: "",
            active: true,
            expanded: true,
            fields: {}
        };
        FIELDS_CONFIG.forEach(f => {
            newChar.fields[f.key] = { text: "", active: true };
        });
        appData.characters.push(newChar);
        renderCharList();
        saveData();
        generatePrompt();
    }

    function deleteChar(id) {
        if(confirm("Delete this character?")) {
            appData.characters = appData.characters.filter(c => c.id !== id);
            renderCharList();
            saveData();
            generatePrompt();
        }
    }

    function toggleExpand(id) {
        const char = appData.characters.find(c => c.id === id);
        if(char) {
            char.expanded = !char.expanded;
            renderCharList();
        }
    }

    function renderCharList() {
        const container = document.getElementById('char-container');
        container.innerHTML = "";

        appData.characters.forEach(char => {
            const card = document.createElement('div');
            card.className = `char-card ${char.active ? '' : 'inactive'} ${char.expanded ? '' : 'collapsed'}`;
            card.dataset.id = char.id;

            const displayName = char.name ? char.name : "New Character";

            let headerHtml = `
                <div class="char-header">
                    <input type="checkbox" class="char-toggle" ${char.active ? 'checked' : ''} onchange="toggleCharActive(${char.id})" title="Enable/Disable Character in Prompt">
                    <div class="char-name-display" onclick="toggleExpand(${char.id})">
                        ${displayName} 
                        <span style="font-size:0.8rem; color:#666; margin-left:5px;">${char.expanded ? '‚ñº' : '‚ñ∂'}</span>
                    </div>
                    <button class="btn" style="padding:2px 8px; font-size:0.7rem; background:transparent; border:1px solid #555;" onclick="deleteChar(${char.id})">‚úñ</button>
                </div>
            `;

            let fieldsHtml = `<div class="char-body ${char.expanded ? '' : 'hidden'}">`;
            
            // ÂêçÂ≠óËæìÂÖ•
            fieldsHtml += `
                <div class="field-block full-width">
                    <div class="field-header">
                        <span class="field-label" style="color:var(--highlight);">CHARACTER NAME</span>
                    </div>
                    <input type="text" class="char-name-input" value="${char.name}" placeholder="e.g. Juri">
                </div>
            `;

            // ËØ¶ÁªÜÂ≠óÊÆµ
            FIELDS_CONFIG.forEach(cfg => {
                const fData = char.fields[cfg.key];
                fieldsHtml += `
                    <div class="field-block ${cfg.full ? 'full-width' : ''} ${fData.active ? '' : 'inactive'}">
                        <div class="field-header">
                            <input type="checkbox" class="field-check field-toggle" data-key="${cfg.key}" ${fData.active ? 'checked' : ''}>
                            <span class="field-label" onclick="toggleFieldCheck(this)">${cfg.label.toUpperCase()}</span>
                        </div>
                        <textarea data-key="${cfg.key}" class="field-text" rows="${cfg.rows}" placeholder="${getPlaceholder(cfg.key)}">${fData.text}</textarea>
                    </div>
                `;
            });
            fieldsHtml += `</div>`;

            card.innerHTML = headerHtml + fieldsHtml;
            container.appendChild(card);
        });
    }

    function getPlaceholder(key) {
        const placeholders = {
            moves: "Specific moves, style (e.g. Taekwondo), ki usage...",
            appearance: "Height, build, eye color, outfit...",
            sexual: "Sexual tension, dynamics, preferences...",
            relationships: "Relation to others, hierarchy..."
        };
        return placeholders[key] || "Details...";
    }

    function toggleCharActive(id) {
        const char = appData.characters.find(c => c.id === id);
        if(char) {
            char.active = !char.active;
            renderCharList(); // Re-render to update opacity
            saveData();
            generatePrompt();
        }
    }

    window.toggleFieldCheck = function(labelEl) {
        const checkbox = labelEl.previousElementSibling;
        checkbox.click();
    }

    function updateCharData(target) {
        const card = target.closest('.char-card');
        const charId = parseInt(card.dataset.id);
        const char = appData.characters.find(c => c.id === charId);
        
        if(!char) return;

        if(target.classList.contains('char-name-input')) {
            char.name = target.value;
            card.querySelector('.char-name-display').innerHTML = (char.name || "New Character") + ` <span style="font-size:0.8rem; color:#666;">‚ñº</span>`;
        } else if (target.classList.contains('field-text')) {
            const key = target.dataset.key;
            char.fields[key].text = target.value;
        } else if (target.classList.contains('field-toggle')) {
            const key = target.dataset.key;
            char.fields[key].active = target.checked;
            const block = target.closest('.field-block');
            if(target.checked) block.classList.remove('inactive');
            else block.classList.add('inactive');
        }
    }

    // --- Prompt ÁîüÊàê ---
    function generatePrompt() {
        let p = "";

        // 1. Meta
        if(appData.useMeta) {
            p += `[INTERNAL STORY NOTES ‚Äî do NOT narrate directly]\n`;
            if(appData.metaGoal) p += `Goal/Theme: ${appData.metaGoal}\n`;
            p += `\n`;
        }

        // 2. Characters
        const activeChars = appData.characters.filter(c => c.active);
        if(activeChars.length > 0) {
            p += `[CHARACTER SHEETS ‚Äî Strict adherence to traits required]\n`;
            activeChars.forEach(c => {
                const name = c.name || "Unknown";
                p += `=== ${name.toUpperCase()} ===\n`;
                FIELDS_CONFIG.forEach(cfg => {
                    const fData = c.fields[cfg.key];
                    if(fData.active && fData.text.trim()) {
                        p += `[${cfg.label}]: ${fData.text}\n`;
                    }
                });
                p += `\n`;
            });
        }

        // 3. Story
        if(appData.useStory && appData.storySoFar) {
            p += `[STORY SO FAR ‚Äî Context only]\n${appData.storySoFar}\n\n`;
        }

        // 4. Task & Beats
        p += `[YOUR TASK]\n${appData.taskOverview || "Write the scene based on the beats below."}\n\n`;
        p += `[SCENE BEATS ‚Äî Organic integration required]\n${appData.sceneBeats}\n\n`;

        // 5. Tone
        if(appData.useTone) {
            p += `[TONE & RULES]\n${appData.toneRules}\n\n`;
            p += `[ENDING INSTRUCTION]\n${appData.endInstr}`;
        }

        document.getElementById('output').textContent = p;
    }

    // --- Â≠òÂÇ® ---
    // ‰ΩøÁî®Êñ∞ÁöÑ Key Á°Æ‰øùÂä†ËΩΩÊñ∞ÁöÑÈªòËÆ§ÂÄº
    const STORAGE_KEY = 'fanfic_builder_v3_1'; 

    function saveData() {
        appData.metaGoal = document.getElementById('meta-goal').value;
        appData.storySoFar = document.getElementById('story-so-far').value;
        appData.taskOverview = document.getElementById('task-overview').value;
        appData.sceneBeats = document.getElementById('scene-beats').value;
        appData.toneRules = document.getElementById('tone-rules').value;
        appData.endInstr = document.getElementById('end-instr').value;
        appData.useMeta = document.getElementById('use-meta').checked;
        appData.useStory = document.getElementById('use-story').checked;
        appData.useTone = document.getElementById('use-tone').checked;

        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        document.getElementById('save-status').textContent = "Saved " + new Date().toLocaleTimeString();
    }

    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            try {
                const parsed = JSON.parse(saved);
                appData = { ...appData, ...parsed };
            } catch(e) { console.error(e); }
        }
        
        // ÊÅ¢Â§ç UI
        document.getElementById('meta-goal').value = appData.metaGoal;
        document.getElementById('story-so-far').value = appData.storySoFar;
        document.getElementById('task-overview').value = appData.taskOverview;
        document.getElementById('scene-beats').value = appData.sceneBeats;
        document.getElementById('tone-rules').value = appData.toneRules; // ËøôÈáå‰ºöÊòØ‰Ω†ÁöÑÈªòËÆ§ÂÄºÊàñ‰øùÂ≠òÁöÑÂÄº
        document.getElementById('end-instr').value = appData.endInstr;
        document.getElementById('use-meta').checked = appData.useMeta;
        document.getElementById('use-story').checked = appData.useStory;
        document.getElementById('use-tone').checked = appData.useTone;
    }

    function clearBeats() {
        document.getElementById('scene-beats').value = "";
        saveData();
    }

    function copyPrompt() {
        navigator.clipboard.writeText(document.getElementById('output').textContent)
            .then(() => {
                const btn = document.querySelector('.btn-primary');
                const orig = btn.innerHTML;
                btn.innerHTML = "‚úÖ Copied!";
                setTimeout(() => btn.innerHTML = orig, 1500);
            });
    }
</script>
</body>
</html>