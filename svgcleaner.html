<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG åˆ€æ¨¡æå–å·¥å…· (A4 æ‰“å°ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f1f5f9;
            --panel-bg: #ffffff;
            --border-color: #cbd5e1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #334155;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        h1 {
            margin: 0 0 15px 0;
            font-size: 1.4rem;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tag {
            background: #e0f2fe;
            color: #0284c7;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #bae6fd;
        }

        .container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .panel {
            flex: 1;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            background: #f8fafc;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .editor-area {
            flex: 1;
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        textarea {
            width: 100%;
            height: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            resize: none;
            box-sizing: border-box;
            background: #fdfdfd;
        }

        textarea:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover { background-color: #1d4ed8; }
        button.secondary { background-color: #64748b; }
        button.secondary:hover { background-color: #475569; }

        .options {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 13px;
            background: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none;
        }

        #preview-container {
            flex: 1;
            /* æ¨¡æ‹Ÿ A4 çº¸èƒŒæ™¯ */
            background-color: #52525b; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 20px;
        }

        /* é¢„è§ˆä¸­çš„ SVG æ ·å¼ */
        #preview-container svg {
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            /* è¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†é¢„è§ˆæ˜¾ç¤ºï¼Œä¸å½±å“ä¸‹è½½æ–‡ä»¶ */
            max-width: 90%; 
            max-height: 90%;
        }

        .stats-bar {
            padding: 8px 15px;
            background: #f1f5f9;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

    <h1>âœ‚ï¸ SVG åˆ€æ¨¡æå–å™¨ <span class="tag">A4 æ‰“å°ç‰ˆ</span></h1>

    <div class="container">
        <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
        <div class="panel">
            <div class="panel-header">
                <span>1. ç²˜è´´åŸå§‹ HTML ä»£ç </span>
                <div class="options">
                    <label title="å¦‚æœå‹¾é€‰ï¼Œè¾“å‡ºå°ºå¯¸å°†è‡ªåŠ¨ç¼©æ”¾ä»¥å¡«æ»¡ A4 çº¸">
                        <input type="checkbox" id="fitA4" checked> 
                        ğŸ“„ ç¼©æ”¾è‡³é“ºæ»¡ A4 çº¸
                    </label>
                </div>
                <button onclick="processSVG()">âœ¨ å¼€å§‹æå–</button>
            </div>
            <div class="editor-area">
                <textarea id="inputCode" placeholder="åœ¨æ­¤å¤„ç²˜è´´åŒ…å« <svg> çš„åŸå§‹ HTML ä»£ç ..."></textarea>
            </div>
        </div>

        <!-- å³ä¾§ï¼šç»“æœåŒºåŸŸ -->
        <div class="panel">
            <div class="panel-header">
                <span>2. é¢„è§ˆ (ç™½è‰²åŒºåŸŸä»£è¡¨A4çº¸/ç”»æ¿)</span>
                <div style="display:flex; gap:10px;">
                    <button class="secondary" onclick="copyToClipboard()">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                    <button onclick="downloadSVG()">ğŸ’¾ ä¸‹è½½ SVG</button>
                </div>
            </div>
            <div class="editor-area" style="padding:0;">
                <div id="preview-container">
                    <span style="color:#a1a1aa">é¢„è§ˆåŒºåŸŸ</span>
                </div>
                <!-- éšè—è¾“å‡ºæ¡† -->
                <textarea id="outputCode" style="display:none;"></textarea>
            </div>
            <div class="stats-bar">
                <span id="statsInfo">ç­‰å¾…å¤„ç†...</span>
                <span id="sizeInfo"></span>
            </div>
        </div>
    </div>

    <script>
        function processSVG() {
            const input = document.getElementById('inputCode').value;
            const fitA4 = document.getElementById('fitA4').checked;

            if (!input.trim()) {
                alert("è¯·å…ˆç²˜è´´ä»£ç ï¼");
                return;
            }

            // 1. æš´åŠ›é¢„å¤„ç†ï¼šç§»é™¤å›¾ç‰‡é˜²æ­¢å¡é¡¿
            let cleanInput = input.replace(/href\s*=\s*["']data:image\/[^"']*["']/g, 'href=""');
            cleanInput = cleanInput.replace(/<image[^>]*>/gi, ''); 

            // 2. è§£æ DOM
            const parser = new DOMParser();
            const doc = parser.parseFromString(cleanInput, 'text/html');
            const originalSvg = doc.querySelector('svg');

            if (!originalSvg) {
                alert("æœªæ‰¾åˆ° <svg> æ ‡ç­¾ï¼Œè¯·æ£€æŸ¥ä»£ç ã€‚");
                return;
            }

            // 3. è·å–åŸå§‹å°ºå¯¸å’Œ viewBox
            // ä¼˜å…ˆä½¿ç”¨ viewBoxï¼Œå› ä¸ºå®ƒæ˜¯æœ€å‡†ç¡®çš„åæ ‡ç³»
            let viewBox = originalSvg.getAttribute('viewBox');
            let vbX=0, vbY=0, vbW=1000, vbH=1000;

            if (viewBox) {
                const parts = viewBox.split(/[\s,]+/).map(parseFloat);
                if(parts.length === 4) { [vbX, vbY, vbW, vbH] = parts; }
            } else {
                // å¦‚æœæ²¡æœ‰ viewBoxï¼Œå°è¯•è¯»å– width/height å±æ€§
                vbW = parseFloat(originalSvg.getAttribute('width')) || 1000;
                vbH = parseFloat(originalSvg.getAttribute('height')) || 1000;
                viewBox = `0 0 ${vbW} ${vbH}`;
            }

            // 4. è®¡ç®—è¾“å‡ºå°ºå¯¸ (æ ¸å¿ƒé€»è¾‘)
            let outputWidthStr, outputHeightStr;
            let sizeInfoText = "";

            if (fitA4) {
                // A4 å°ºå¯¸ (mm)
                const A4_W = 210;
                const A4_H = 297;
                const MARGIN = 10; // è¾¹è· 10mm
                
                // å¯ç”¨åŒºåŸŸ
                const targetW = A4_W - (MARGIN * 2);
                const targetH = A4_H - (MARGIN * 2);

                // è®¡ç®—å®½é«˜æ¯”
                const contentRatio = vbW / vbH;
                const targetRatio = targetW / targetH;

                let finalW, finalH;

                // ç®€å•çš„ç¼©æ”¾é€»è¾‘ï¼šfit inside
                if (contentRatio > targetRatio) {
                    // å†…å®¹æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
                    finalW = targetW;
                    finalH = targetW / contentRatio;
                } else {
                    // å†…å®¹æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                    finalH = targetH;
                    finalW = targetH * contentRatio;
                }

                outputWidthStr = finalW.toFixed(2) + "mm";
                outputHeightStr = finalH.toFixed(2) + "mm";
                sizeInfoText = `ğŸ“¦ å°ºå¯¸å·²è°ƒæ•´: ${outputWidthStr} x ${outputHeightStr} (é€‚é… A4)`;

            } else {
                // ä¿æŒåŸå§‹å°ºå¯¸ (å‡è®¾ SVG é‡Œçš„å•ä½å¯ä»¥ç›´æ¥ç”¨ï¼Œæˆ–è€…æ˜¯åƒç´ )
                // å¤§å¤šæ•° web SVG æ˜¯åƒç´ ï¼Œä¸ºäº† AI æ‰“å¼€ä¸å˜æˆå¾®ç±³çº§ï¼Œæˆ‘ä»¬ä¸åŠ å•ä½ï¼Œè®© AI é»˜è®¤ä¸º px
                outputWidthStr = vbW;
                outputHeightStr = vbH;
                sizeInfoText = `ğŸ“¦ åŸå§‹å°ºå¯¸ (æœªç¼©æ”¾)`;
            }

            // 5. æå–è·¯å¾„
            const cutLines = [];
            const foldLines = [];
            const elements = doc.querySelectorAll('path, line, polyline, rect, circle, ellipse');

            elements.forEach(el => {
                const stroke = el.getAttribute('stroke');
                if (!stroke) return;

                // é¢œè‰²è¯†åˆ«ç‰¹å¾
                const isBlue = stroke.includes('#2028b0') || stroke.includes('32, 40, 176') || stroke.includes('32,40,176');
                const isRed = stroke.includes('#fa0000') || stroke.includes('250, 0, 0') || stroke.includes('250,0,0');

                if (!isBlue && !isRed) return;

                // å±æ€§æ¸…æ´—
                let attrs = [];
                ['d', 'x1', 'y1', 'x2', 'y2', 'cx', 'cy', 'r', 'rx', 'ry', 'points'].forEach(attr => {
                    if (el.hasAttribute(attr)) attrs.push(`${attr}="${el.getAttribute(attr)}"`);
                });

                // ä¿ç•™çº¿å‹ï¼ˆè™šçº¿ï¼‰
                if (el.hasAttribute('stroke-dasharray')) attrs.push(`stroke-dasharray="${el.getAttribute('stroke-dasharray')}"`);
                
                // ç»Ÿä¸€çº¿å®½ï¼Œæ–¹ä¾¿æ‰“å°çœ‹æ¸… (0.5px)
                attrs.push(`stroke-width="0.5"`);

                const tag = el.tagName.toLowerCase();
                
                if (isBlue) {
                    cutLines.push(`    <${tag} ${attrs.join(' ')} />`);
                } else if (isRed) {
                    foldLines.push(`    <${tag} ${attrs.join(' ')} />`);
                }
            });

            // 6. ç”Ÿæˆæœ€ç»ˆ SVG
            // æ³¨æ„ï¼šæˆ‘ä»¬é€šè¿‡ width/height è®¾ç½®ç‰©ç†å°ºå¯¸ï¼Œä½† viewBox ä¿æŒåŸå§‹æ•°æ®ä¸å˜ï¼Œ
            // è¿™æ ·å°±å®ç°äº†â€œç¼©æ”¾å†…å®¹ä»¥é€‚åº”çº¸å¼ â€è€Œä¸ç ´åå›¾å½¢å‡ ä½•å…³ç³»ã€‚
            const outputSvg = `
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${outputWidthStr}" height="${outputHeightStr}" viewBox="${viewBox}">
  <!-- åˆ‡å‰²çº¿ (Cut) - è“è‰² -->
  <g id="cut-lines" stroke="#2028b0" fill="none">
${cutLines.join('\n')}
  </g>

  <!-- æŠ˜å çº¿ (Fold) - çº¢è‰² -->
  <g id="fold-lines" stroke="#fa0000" fill="none">
${foldLines.join('\n')}
  </g>
</svg>`.trim();

            // 7. æ›´æ–°ç•Œé¢
            document.getElementById('preview-container').innerHTML = outputSvg;
            document.getElementById('outputCode').value = outputSvg;
            document.getElementById('statsInfo').innerHTML = `ğŸ”µ åˆ‡å‰²çº¿: ${cutLines.length} | ğŸ”´ æŠ˜å çº¿: ${foldLines.length}`;
            document.getElementById('sizeInfo').innerHTML = sizeInfoText;
        }

        function downloadSVG() {
            const content = document.getElementById('outputCode').value;
            if (!content) return;
            const blob = new Blob([content], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dieline_A4.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const content = document.getElementById('outputCode');
            if (!content.value) return;
            content.style.display = 'block';
            content.select();
            document.execCommand('copy');
            content.style.display = 'none';
            const btn = document.querySelector('button.secondary');
            const originalText = btn.innerText;
            btn.innerText = 'âœ… å·²å¤åˆ¶';
            setTimeout(() => btn.innerText = originalText, 1500);
        }
    </script>
</body>
</html>