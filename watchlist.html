<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watchlist</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ä¿ç•™å°‘é‡è‡ªå®šä¹‰ï¼ˆå’Œ Tailwind å…±å­˜ï¼‰ */
        .actress-item {
            border-left-width: 4px;
        }

        .site-popup {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            border-radius: 0.5rem;
            z-index: 1000;
            min-width: 200px;
        }

        .site-popup a {
            display: block;
            padding: 10px 16px;
            color: #111827;
            text-decoration: none;
            border-bottom: 1px solid #f3f4f6;
        }

        .site-popup a:hover {
            background-color: #f8fafc;
        }

        /* Toast å°æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            transform: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.25s;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">
    <div class="max-w-4xl mx-auto p-6">
        <header class="mb-6">
            <h1 class="text-2xl font-semibold text-slate-900 text-center">Watchlist</h1>
            <p class="mt-2 text-center text-sm text-slate-500">ç®¡ç†å…³æ³¨å¥³ä¼˜ä¸ä½œå“ â€” æ”¯æŒç¼–è¾‘ / æ’åº / æœç´¢ç«™ç‚¹</p>
        </header>

        <!-- æ“ä½œåŒºï¼šæ·»åŠ  & æ’åºå¼€å…³ -->
        <div class="mb-4 flex flex-wrap gap-3 items-center justify-between">
            <div class="flex gap-3">
                <button id="addActress" class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">+
                    æ·»åŠ å¥³ä¼˜</button>

                <button id="toggleSortMode"
                    class="px-3 py-1 rounded border border-slate-200 bg-white hover:bg-slate-50">
                    æ’åºæ¨¡å¼
                </button>

                <button id="saveSortBtn"
                    class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 hidden">ä¿å­˜æ’åº</button>
                <button id="cancelSortBtn"
                    class="px-3 py-1 rounded border border-slate-200 bg-white hover:bg-slate-50 hidden">å–æ¶ˆæ’åº</button>
            </div>

            <div class="text-sm text-slate-500">æç¤ºï¼šè¿›å…¥æ’åºæ¨¡å¼åï¼Œä½¿ç”¨å·¦å³çš„æŒ‰é’®è°ƒæ•´é¡ºåºï¼Œå®Œæˆåç‚¹å‡»â€œä¿å­˜æ’åºâ€ã€‚</div>
        </div>

        <!-- å¥³ä¼˜åˆ—è¡¨ -->
        <section class="mb-6">
            <div id="actressList" class="space-y-4"></div>
        </section>

        <!-- Site List ç¼–è¾‘åŒº -->
        <section class="bg-white rounded-lg shadow p-5">
            <h2 class="text-lg font-medium mb-2">æœç´¢ç«™ç‚¹åˆ—è¡¨</h2>
            <p class="text-sm text-slate-500 mb-2">æ¯è¡Œä¸€ä¸ªç«™ç‚¹åï¼Œä¾‹å¦‚ï¼š<code class="bg-slate-100 px-1 rounded">xasiat</code></p>
            <textarea id="siteListInput" class="w-full border rounded p-3 min-h-[120px] text-sm"></textarea>
            <div class="mt-3 flex gap-3">
                <button id="saveSiteList"
                    class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">ä¿å­˜ç«™ç‚¹åˆ—è¡¨</button>
                <button id="resetSiteList" class="px-3 py-1 rounded border bg-white">é‡ç½®ä¸ºå½“å‰æ•°æ®</button>
            </div>
        </section>
    </div>

    <!-- ç«™ç‚¹å¼¹å‡ºèœå• -->
    <div id="sitePopup" class="site-popup hidden"></div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast px-4 py-2 rounded shadow bg-yellow-300 text-slate-800"></div>

    <script>
        // ========================
        // é…ç½®ï¼šè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Bin ID å’Œ Access Key
        // ========================
        const BIN_ID = '68d60a1643b1c97be9506422';
        const ACCESS_KEY = '$2a$10$Hi5BNn/VXRh8AX9uTMxQMezW9baqQFhRNXmih/MWi.x0OJ.yKc9m.';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // å…¨å±€æ•°æ®ï¼ˆruntimeï¼‰
        let data = {
            config: { sitelist: [] },
            actresses: []
        };

        // æœ¬åœ°æ’åºä¸´æ—¶å‰¯æœ¬ï¼ˆè¿›å…¥æ’åºæ¨¡å¼æ—¶ç”Ÿæˆï¼‰
        let sortMode = false;
        let stagingActresses = null; // ç”¨äºæ’åºä½†æœªä¿å­˜

        // ========================
        // å·¥å…·å‡½æ•°
        // ========================
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast px-4 py-2 rounded shadow ' + (isError ? 'bg-red-600 text-white' : 'bg-amber-300 text-slate-900') + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, isError ? 4000 : 2500);
        }

        async function fetchData() {
            try {
                const res = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': ACCESS_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                if (!res.ok) throw new Error(`åŠ è½½å¤±è´¥: ${res.status}`);
                const json = await res.json();
                return json.record;
            } catch (err) {
                console.error('Fetch failed:', err);
                throw err;
            }
        }

        async function updateData(payload) {
            const res = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'X-Access-Key': ACCESS_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`ä¿å­˜å¤±è´¥: ${res.status}`);
            return res.json();
        }

        // è§£æ Markdown å¾…åŠé¡¹ï¼šæ”¯æŒ - [ ] / - [x] / æ™®é€šè¡Œ
        function parseWorks(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const matchDone = line.match(/^\s*-\s*\[x\]\s*(.+)$/i);
                const matchNotDone = line.match(/^\s*-\s*\[\s\]\s*(.+)$/);

                if (matchDone) {
                    return { title: matchDone[1].trim(), done: true };
                } else if (matchNotDone) {
                    return { title: matchNotDone[1].trim(), done: false };
                } else {
                    return { title: line.trim(), done: false };
                }
            });
        }

        function generateWorksText(works) {
            return works.map(w => w.done ? `- [x] ${w.title}` : `- [ ] ${w.title}`).join('\n');
        }

        async function saveToCloud(payload = null) {
            try {
                // å¦‚æœä¼ äº† payload å°±ç”¨å®ƒï¼ˆç”¨äºä¿å­˜æ’åºæ—¶ï¼‰ï¼Œå¦åˆ™ç”¨å…¨å±€ data
                const toSave = payload || data;
                await updateData(toSave);
                showToast('å·²ä¿å­˜åˆ°äº‘ç«¯ï¼');
                // å¦‚æœä¿å­˜åæ˜¯æˆåŠŸä¿å­˜æ’åºï¼Œè¦åŒæ­¥ä¸» data
                if (payload) {
                    data = JSON.parse(JSON.stringify(payload));
                }
            } catch (err) {
                showToast(err.message || 'ä¿å­˜å¤±è´¥', true);
            }
        }

        // ========================
        // DOM æ“ä½œ
        // ========================
        function renderSiteList() {
            const el = document.getElementById('siteListInput');
            el.value = (data.config && data.config.sitelist) ? data.config.sitelist.join('\n') : '';
        }

        document.getElementById('saveSiteList').addEventListener('click', () => {
            const text = document.getElementById('siteListInput').value;
            data.config.sitelist = text.split('\n').map(s => s.trim()).filter(s => s !== '');
            saveToCloud();
        });
        document.getElementById('resetSiteList').addEventListener('click', () => {
            renderSiteList();
            showToast('å·²æ¢å¤ä¸ºå½“å‰æ•°æ®');
        });

        // æ·»åŠ æ–°å¥³ä¼˜
        document.getElementById('addActress').addEventListener('click', () => {
            const name = prompt('è¯·è¾“å…¥å¥³ä¼˜å§“åï¼š');
            if (!name) return;
            data.actresses.push({
                name,
                expanded: true,
                works: []
            });
            renderActressList();
            saveToCloud();
        });

        // æ’åºæ¨¡å¼åˆ‡æ¢æŒ‰é’®ç»‘å®š
        const toggleSortBtn = document.getElementById('toggleSortMode');
        const saveSortBtn = document.getElementById('saveSortBtn');
        const cancelSortBtn = document.getElementById('cancelSortBtn');

        toggleSortBtn.addEventListener('click', () => {
            sortMode = !sortMode;
            if (sortMode) {
                // è¿›å…¥æ’åºæ¨¡å¼ï¼šå¤åˆ¶ä¸€ä¸ª staging æ•°ç»„ç”¨äºæ“ä½œï¼ˆä¸æ”¹ä¸» dataï¼‰
                stagingActresses = JSON.parse(JSON.stringify(data.actresses || []));
                toggleSortBtn.textContent = 'é€€å‡ºæ’åº';
                saveSortBtn.classList.remove('hidden');
                cancelSortBtn.classList.remove('hidden');
                showToast('è¿›å…¥æ’åºæ¨¡å¼ï¼ˆæ”¹å˜å°šæœªä¿å­˜ï¼‰');
            } else {
                // é€€å‡ºæ’åºæ¨¡å¼ï¼šæ”¾å¼ƒ staging
                stagingActresses = null;
                toggleSortBtn.textContent = 'æ’åºæ¨¡å¼';
                saveSortBtn.classList.add('hidden');
                cancelSortBtn.classList.add('hidden');
            }
            renderActressList();
        });

        cancelSortBtn.addEventListener('click', () => {
            // æ”¾å¼ƒæ”¹åŠ¨ï¼Œæ¢å¤ä¸» data
            sortMode = false;
            stagingActresses = null;
            toggleSortBtn.textContent = 'æ’åºæ¨¡å¼';
            saveSortBtn.classList.add('hidden');
            cancelSortBtn.classList.add('hidden');
            renderActressList();
            showToast('å·²å–æ¶ˆæ’åºæ“ä½œ');
        });

        saveSortBtn.addEventListener('click', async () => {
            if (!stagingActresses) return;
            const payload = {
                ...data,
                actresses: JSON.parse(JSON.stringify(stagingActresses))
            };
            await saveToCloud(payload);
            // åº”ç”¨åˆ°ä¸» dataï¼Œå¹¶é€€å‡ºæ’åºæ¨¡å¼
            data = payload;
            sortMode = false;
            stagingActresses = null;
            toggleSortBtn.textContent = 'æ’åºæ¨¡å¼';
            saveSortBtn.classList.add('hidden');
            cancelSortBtn.classList.add('hidden');
            renderActressList();
        });

        // æ¸²æŸ“æ‰€æœ‰å¥³ä¼˜ï¼ˆæ ¹æ® sortMode å†³å®šç”¨ data.actresses è¿˜æ˜¯ stagingActressesï¼‰
        // æ¸²æŸ“æ‰€æœ‰å¥³ä¼˜ï¼ˆæ ¹æ® sortMode å†³å®šç”¨ data.actresses è¿˜æ˜¯ stagingActressesï¼‰
        function renderActressList() {
            const container = document.getElementById('actressList');
            container.innerHTML = '';

            // é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„æ•°æ®æº
            const list = sortMode ? (stagingActresses || []) : (data.actresses || []);

            if (!list.length) {
                container.innerHTML = `<div class="bg-white p-4 rounded shadow text-slate-500">æš‚æ— å…³æ³¨å¥³ä¼˜ï¼Œç‚¹å‡»â€œ+ æ·»åŠ å¥³ä¼˜â€æ·»åŠ ã€‚</div>`;
                return;
            }

            list.forEach((a, idx) => {
                const item = document.createElement('div');
                item.className = 'actress-item bg-white rounded-lg p-4 shadow-sm flex flex-col';

                // headerï¼šå·¦ä¾§ä¸ºç®­å¤´+åå­—ï¼Œå³ä¾§ä¸ºæŒ‰é’®
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between gap-4';

                // å·¦ä¾§ï¼šç®­å¤´ + åå­—ï¼ˆå¯ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰
                const leftBox = document.createElement('div');
                leftBox.className = 'flex items-center gap-3 cursor-pointer select-none';

                const arrowSpan = document.createElement('span');
                arrowSpan.className = 'arrow inline-block transition-transform duration-200';
                arrowSpan.textContent = 'â–¶';
                arrowSpan.style.transform = a.expanded ? 'rotate(90deg)' : 'rotate(0deg)';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-lg font-medium text-slate-800';
                nameSpan.textContent = a.name;

                leftBox.appendChild(arrowSpan);
                leftBox.appendChild(nameSpan);

                // ç‚¹å‡»åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
                leftBox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const arr = sortMode ? stagingActresses : data.actresses;
                    if (!arr || !arr[idx]) return;
                    arr[idx].expanded = !arr[idx].expanded;
                    if (!sortMode) saveToCloud(); // éæ’åºæ¨¡å¼ç«‹å³ä¿å­˜
                    renderActressList(); // é‡æ–°æ¸²æŸ“
                });

                // å³ä¾§ï¼šæ’åºæˆ–åˆ é™¤æŒ‰é’®
                const rightBox = document.createElement('div');
                rightBox.className = 'flex items-center gap-2';

                if (sortMode) {
                    const mkBtn = (text, title, handler) => {
                        const b = document.createElement('button');
                        b.className = 'text-sm px-2 py-1 rounded hover:bg-slate-100';
                        b.title = title;
                        b.textContent = text;
                        b.onclick = (ev) => { ev.stopPropagation(); handler(); };
                        return b;
                    };
                    rightBox.appendChild(mkBtn('ğŸ”', 'ç½®é¡¶', () => moveActress(idx, 'top')));
                    rightBox.appendChild(mkBtn('â¬†', 'ä¸Šç§»', () => moveActress(idx, 'up')));
                    rightBox.appendChild(mkBtn('â¬‡', 'ä¸‹ç§»', () => moveActress(idx, 'down')));
                    rightBox.appendChild(mkBtn('ğŸ”š', 'ç½®åº•', () => moveActress(idx, 'bottom')));
                }

                // åˆ é™¤æŒ‰é’®
                const delBtn = document.createElement('button');
                delBtn.className = 'text-sm px-2 py-1 rounded hover:bg-rose-50';
                delBtn.title = 'åˆ é™¤';
                delBtn.innerHTML = `<span class="text-rose-600">ğŸ—‘ï¸</span>`;
                delBtn.style.background = 'transparent';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤å¥³ä¼˜ "${a.name}" å—ï¼Ÿ`)) return;
                    if (sortMode) {
                        stagingActresses.splice(idx, 1);
                    } else {
                        data.actresses.splice(idx, 1);
                    }
                    if (!sortMode) saveToCloud();
                    renderActressList();
                };
                rightBox.appendChild(delBtn);

                header.appendChild(leftBox);
                header.appendChild(rightBox);
                item.appendChild(header);

                // å†…å®¹åŒºï¼šåªåœ¨ expanded æ—¶æ˜¾ç¤ºå†…å®¹
                const content = document.createElement('div');
                content.className = 'actress-content mt-3';

                if (a.expanded) {
                    // åˆ›å»º textareaï¼ˆç¼–è¾‘åŒºï¼‰
                    const textarea = document.createElement('textarea');
                    textarea.className = 'works-input w-full border rounded p-2 text-sm';
                    textarea.value = generateWorksText(a.works || []);
                    textarea.dataset.index = idx;
                    textarea.style.display = 'none'; // é»˜è®¤éšè—

                    // ä¿å­˜æŒ‰é’®
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'mt-2 px-3 py-1 rounded bg-indigo-600 text-white hidden';
                    saveBtn.textContent = 'ä¿å­˜ä½œå“';
                    saveBtn.onclick = (e) => {
                        e.stopPropagation();
                        const text = textarea.value;
                        const arr = sortMode ? stagingActresses : data.actresses;
                        if (!arr || !arr[idx]) return;
                        arr[idx].works = parseWorks(text);
                        if (!sortMode) saveToCloud();
                        renderActressList();
                    };

                    // ä½œå“åˆ—è¡¨å®¹å™¨
                    const workList = document.createElement('ul');
                    workList.className = 'work-list space-y-2';

                    // ç¼–è¾‘æŒ‰é’®
                    const editBtn = document.createElement('button');
                    editBtn.className = 'mt-3 px-3 py-1 rounded border border-slate-200 bg-white';
                    editBtn.textContent = 'ç¼–è¾‘ä½œå“';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        const show = textarea.style.display === 'none';
                        textarea.style.display = show ? 'block' : 'none';
                        saveBtn.style.display = show ? 'inline-block' : 'none';
                        editBtn.textContent = show ? 'å–æ¶ˆç¼–è¾‘' : 'ç¼–è¾‘ä½œå“';
                        const arr = sortMode ? stagingActresses : data.actresses;
                        textarea.value = generateWorksText((arr[idx] && arr[idx].works) ? arr[idx].works : []);
                    };

                    // æ·»åŠ åˆ° content
                    content.appendChild(textarea);
                    content.appendChild(saveBtn);
                    content.appendChild(workList);
                    content.appendChild(editBtn);

                    // æ¸²æŸ“ä½œå“åˆ—è¡¨
                    renderWorkList(workList, idx, sortMode);
                }
                // å¦‚æœ !a.expandedï¼Œcontent ä¸ºç©ºï¼Œä¸æ·»åŠ ä»»ä½•å†…å®¹

                item.appendChild(content);
                container.appendChild(item);
            });
        }
        // æ¸²æŸ“å•ä¸ªä½œå“åˆ—è¡¨
        function renderWorkList(container, actressIdx, isStaging = false) {
            if (!container || !container.tagName) return;
            container.innerHTML = '';
            const arr = isStaging ? (stagingActresses || []) : (data.actresses || []);
            const works = (arr[actressIdx] && arr[actressIdx].works) ? arr[actressIdx].works : [];

            works.forEach((work, workIdx) => {
                const li = document.createElement('li');
                li.className = `work-item flex items-center gap-3 p-2 rounded ${work.done ? 'line-through text-slate-400 bg-slate-50' : 'bg-slate-100'}`;

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = work.done;
                cb.onchange = (e) => {
                    work.done = cb.checked;
                    // å¦‚æœåœ¨æ’åºæ¨¡å¼ä¸‹ï¼Œä¿®æ”¹ stagingï¼Œå¦åˆ™ä¿®æ”¹ data
                    if (isStaging) {
                        // stagingActresses already references correct object
                    } else {
                        // ä¿å­˜å‹¾é€‰çŠ¶æ€
                        saveToCloud();
                    }
                    // åªé‡æ–°æ¸²æŸ“ the list
                    renderActressList();
                };

                const titleSpan = document.createElement('span');
                titleSpan.className = 'title flex-1 cursor-pointer';
                titleSpan.textContent = work.title;
                titleSpan.onclick = (e) => {
                    e.stopPropagation();
                    showSitePopup(e, work.title);
                };

                li.appendChild(cb);
                li.appendChild(titleSpan);
                container.appendChild(li);
            });
        }

        // æ˜¾ç¤ºç«™ç‚¹å¼¹å‡ºèœå•
        function showSitePopup(e, title) {
            const popup = document.getElementById('sitePopup');
            popup.innerHTML = '';
            popup.classList.remove('hidden');

            const rect = e.target.getBoundingClientRect();
            popup.style.left = `${rect.left}px`;
            popup.style.top = `${rect.bottom + window.scrollY + 8}px`;

            (data.config.sitelist || []).forEach(site => {
                const a = document.createElement('a');
                a.href = `https://www.google.com/search?q=${encodeURIComponent(title + ' ' + site)}`;
                a.target = "_blank";
                a.textContent = `ğŸ” æœç´¢ ${site}`;
                popup.appendChild(a);
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
            function close(event) {
                if (!popup.contains(event.target) && !event.target.classList.contains('title')) {
                    popup.classList.add('hidden');
                    document.removeEventListener('click', close);
                }
            }
            setTimeout(() => document.addEventListener('click', close), 100);
        }

        // æ’åºç§»åŠ¨å‡½æ•°ï¼ˆä¿®æ”¹ stagingActressesï¼‰
        function moveActress(i, action) {
            if (!stagingActresses) return;
            const arr = stagingActresses;
            if (action === 'top' && i > 0) {
                arr.unshift(arr.splice(i, 1)[0]);
            } else if (action === 'up' && i > 0) {
                [arr[i - 1], arr[i]] = [arr[i], arr[i - 1]];
            } else if (action === 'down' && i < arr.length - 1) {
                [arr[i + 1], arr[i]] = [arr[i], arr[i + 1]];
            } else if (action === 'bottom' && i < arr.length - 1) {
                arr.push(arr.splice(i, 1)[0]);
            }
            renderActressList();
        }

        // ========================
        // åˆå§‹åŒ–
        // ========================
        async function init() {
            const container = document.getElementById('actressList');
            container.innerHTML = '<div class="bg-white p-4 rounded shadow text-slate-500 italic">åŠ è½½ä¸­...</div>';

            try {
                const fetched = await fetchData();
                if (fetched) data = fetched;
            } catch (err) {
                container.innerHTML = `<div class="bg-rose-50 p-4 rounded text-rose-700">åŠ è½½å¤±è´¥ï¼š${err.message}ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–å¯†é’¥ã€‚</div>`;
                showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è®¾ç½®', true);
                console.error(err);
            }

            if (!data.config) data.config = { sitelist: [] };
            if (!data.actresses) data.actresses = [];

            renderSiteList();
            renderActressList();
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>