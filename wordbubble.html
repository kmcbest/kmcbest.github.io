<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bubble Pop English</title>
    <style>
        :root {
            --bg-top: #81d4fa;
            --bg-bottom: #29b6f6;
            --bubble-border: rgba(255, 255, 255, 0.6);
        }

        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            touch-action: none; /* ç¦æ­¢æ‰‹æœºé»˜è®¤è§¦æ‘¸è¡Œä¸º */
            user-select: none;
        }

        /* UI å±‚ï¼šä½äºæ¸¸æˆå±‚ä¹‹ä¸Š */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°æ¸¸æˆå±‚ */
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
            gap: 20px; /* å¢åŠ å…ƒç´ ä¹‹é—´çš„é—´è· */
            padding: 20px;
            box-sizing: border-box;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* ç›®æ ‡æç¤ºæ¿ */
        .target-board {
            align-self: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 30px;
            border-radius: 50px;
            border: 4px solid #FFC107;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            pointer-events: auto; /* å…è®¸ç‚¹å‡»å¬è¯»éŸ³ */
            cursor: pointer;
            transition: transform 0.1s;
            margin-top: 10px;
        }
        .target-board:active { transform: scale(0.95); }

        .target-word {
            font-size: 2.5rem;
            color: #333;
            display: block;
            line-height: 1;
        }
        .target-label {
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
        }

        /* å¼€å§‹/ç»“æŸ é®ç½©å±‚ */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .menu-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 5px solid #4CAF50;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        h1 { margin: 0 0 10px 0; color: #2E7D32; font-size: 3rem; }
        p { font-size: 1.5rem; color: #555; margin: 10px 0 30px 0; }

        .btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 15px 60px;
            font-size: 1.8rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #F57C00;
            font-family: inherit;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        /* æ³¡æ³¡æ ·å¼ */
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.4));
            box-shadow: 0 0 10px rgba(255,255,255,0.5), inset 0 0 20px rgba(255,255,255,0.5);
            border: 2px solid var(--bubble-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            user-select: none;
            will-change: transform, top;
            z-index: 5;
            /* å‘¼å¸åŠ¨ç”» */
            animation: breathe 2s infinite ease-in-out alternate;
        }

        @keyframes breathe {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        /* çˆ†è£‚ç‰¹æ•ˆ */
        .pop-effect {
            position: absolute;
            font-size: 4rem;
            font-weight: bold;
            color: white;
            pointer-events: none;
            animation: floatUpFade 0.8s forwards;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 15;
        }

        @keyframes floatUpFade {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

    <!-- UI ç•Œé¢ -->
    <div id="ui-layer">
        <div class="header-info">
            <span>â¤ï¸ <span id="lives">3</span></span>
            <span>ğŸ† <span id="score">0</span></span>
        </div>

        <div class="target-board" id="targetBoard" onclick="speakTarget()">
            <span class="target-label">Target:</span>
            <span class="target-word" id="targetWord">READY</span>
        </div>

        <div style="height: 50px;"></div> <!-- å ä½ -->
    </div>

    <!-- èœå•/ç»“ç®—é®ç½© -->
    <div id="overlay">
        <div class="menu-card" id="menuCard">
            <h1>Bubble Pop!</h1>
            <p>Look & Listen.<br>Pop only the right bubbles!</p>
            <button class="btn" onclick="startGame()">PLAY</button>
        </div>
    </div>

    <!-- æ¸¸æˆåŒºåŸŸ (æ³¡æ³¡å®¹å™¨) -->
    <div id="game-container"></div>

    <script>
        // ==================== 1. æ ¸å¿ƒæ•°æ® ====================
        const gameData = [
            { id: 'dog', emoji: 'ğŸ¶', word: 'Dog' },
            { id: 'cat', emoji: 'ğŸ±', word: 'Cat' },
            { id: 'pig', emoji: 'ğŸ·', word: 'Pig' },
            { id: 'fox', emoji: 'ğŸ¦Š', word: 'Fox' },
            { id: 'bee', emoji: 'ğŸ', word: 'Bee' },
            { id: 'car', emoji: 'ğŸš—', word: 'Car' },
            { id: 'bus', emoji: 'ğŸšŒ', word: 'Bus' },
            { id: 'sun', emoji: 'ğŸŒ', word: 'Sun' },
            { id: 'moon', emoji: 'ğŸŒ™', word: 'Moon' },
            { id: 'star', emoji: 'â­', word: 'Star' },
            { id: 'apple', emoji: 'ğŸ', word: 'Apple' },
            { id: 'banana', emoji: 'ğŸŒ', word: 'Banana' },
            { id: 'fish', emoji: 'ğŸŸ', word: 'Fish' },
            { id: 'ball', emoji: 'âš½', word: 'Ball' },
            { id: 'book', emoji: 'ğŸ“–', word: 'Book' }
        ];

        // ==================== 2. éŸ³é¢‘ç³»ç»Ÿ ====================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const sfx = {
            // æ³¡æ³¡ç ´è£‚å£° (é«˜é¢‘çŸ­éŸ³)
            pop: (combo = 0) => { 
                // è¿å‡»è¶Šé«˜ï¼ŒéŸ³è°ƒè¶Šé«˜
                const pitch = 400 + (combo * 100);
                playTone(pitch, 'sine', 0.01, 0.1); 
            },
            // é”™è¯¯å£° (ä½æ²‰æ‚éŸ³)
            wrong: () => playTone(150, 'sawtooth', 0.05, 0.3),
            // æ¸¸æˆç»“æŸ
            over: () => playMelody([300, 250, 200, 150], 0.2)
        };

        function playTone(freq, type, attack, decay) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + attack);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + attack + decay);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + attack + decay);
        }

        function playMelody(notes, speed) {
            notes.forEach((note, i) => setTimeout(() => playTone(note, 'triangle', 0.05, speed), i * speed * 1000));
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 1.0;
            window.speechSynthesis.speak(u);
        }

        // ==================== 3. æ¸¸æˆå¼•æ“ ====================
        
        const container = document.getElementById('game-container');
        const overlay = document.getElementById('overlay');
        const menuCard = document.getElementById('menuCard');
        
        let state = {
            isPlaying: false,
            score: 0,
            lives: 3,
            targetItem: null, // å½“å‰è¦æ‰¾çš„ç›®æ ‡å¯¹è±¡
            bubbles: [], // å±å¹•ä¸Šçš„æ³¡æ³¡DOMæ•°ç»„
            spawnRate: 1500, // åˆå§‹ç”Ÿæˆé€Ÿåº¦ (ms)
            speed: 2, // åˆå§‹ä¸Šå‡é€Ÿåº¦ (px/frame)
            lastSpawnTime: 0,
            combo: 0,
            gameLoopId: null
        };

        function startGame() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            // é‡ç½®æ•°æ®
            state.score = 0;
            state.lives = 3;
            state.bubbles = [];
            state.spawnRate = 1500;
            state.speed = 2;
            state.combo = 0;
            state.isPlaying = true;
            
            // æ¸…ç©ºå±å¹•
            container.innerHTML = '';
            updateUI();
            
            overlay.style.display = 'none';
            
            // è®¾ç½®ç¬¬ä¸€ä¸ªç›®æ ‡
            setNewTarget();

            // å¯åŠ¨å¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        function setNewTarget() {
            // éšæœºé€‰ä¸€ä¸ªä½œä¸ºç›®æ ‡
            state.targetItem = gameData[Math.floor(Math.random() * gameData.length)];
            
            // æ›´æ–°UI
            document.getElementById('targetWord').innerText = state.targetItem.word;
            
            // è§†è§‰æé†’
            const board = document.getElementById('targetBoard');
            board.style.transform = "scale(1.2)";
            setTimeout(() => board.style.transform = "scale(1)", 200);

            // è¯»å‡ºæ¥
            speak("Find the " + state.targetItem.word);
        }

        function speakTarget() {
            if(state.targetItem) speak(state.targetItem.word);
        }

        function gameLoop(timestamp) {
            if (!state.isPlaying) return;

            // 1. ç”Ÿæˆæ³¡æ³¡
            if (timestamp - state.lastSpawnTime > state.spawnRate) {
                spawnBubble();
                state.lastSpawnTime = timestamp;
                
                // éš¾åº¦éšæ—¶é—´å¢åŠ ï¼šç”Ÿæˆå˜å¿«ï¼Œé€Ÿåº¦å˜å¿«
                if(state.spawnRate > 600) state.spawnRate -= 10; 
                if(state.speed < 6) state.speed += 0.002;
            }

            // 2. ç§»åŠ¨æ³¡æ³¡
            const bubblesToRemove = [];
            state.bubbles.forEach(b => {
                // æ›´æ–°ä½ç½®
                let y = parseFloat(b.dataset.y);
                y += (parseFloat(b.dataset.speed) || state.speed);
                b.dataset.y = y;
                b.style.top = y + 'px';

                // æ£€æŸ¥æ˜¯å¦é£˜å‡ºé¡¶éƒ¨
                if (y > window.innerHeight + 80) {
                    bubblesToRemove.push(b);
                    // å¦‚æœé£˜èµ°çš„æ˜¯ç›®æ ‡ï¼Œä¸”ç©å®¶æ²¡ç‚¹ï¼Œå¯ä»¥æ‰£åˆ†ä¹Ÿå¯ä»¥ä¸æ‰£
                    // è¿™é‡Œè®¾è®¡è½»æ¾ä¸€ç‚¹ï¼šé£˜èµ°ä¸æ‰£å‘½ï¼Œåªæ‰£è¿å‡»
                    if(b.dataset.id === state.targetItem.id) {
                        state.combo = 0;
                    }
                }
            });

            // 3. æ¸…ç†é£˜å‡ºå»çš„æ³¡æ³¡
            bubblesToRemove.forEach(b => removeBubble(b));

            state.gameLoopId = requestAnimationFrame(gameLoop);
        }

        function spawnBubble() {
            // å†³å®šç”Ÿæˆä»€ä¹ˆï¼š30%æ¦‚ç‡æ˜¯ç›®æ ‡ï¼Œ70%æ˜¯å¹²æ‰°é¡¹
            let item;
            if (Math.random() < 0.35) {
                item = state.targetItem;
            } else {
                // éšæœºæ‰¾ä¸€ä¸ªéç›®æ ‡çš„å¹²æ‰°é¡¹
                let distractor = gameData[Math.floor(Math.random() * gameData.length)];
                while(distractor.id === state.targetItem.id) {
                    distractor = gameData[Math.floor(Math.random() * gameData.length)];
                }
                item = distractor;
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerText = item.emoji;
            bubble.dataset.id = item.id;
            bubble.dataset.speed = state.speed * (0.8 + Math.random() * 0.4); // é€Ÿåº¦æœ‰å¿«æœ‰æ…¢

            // éšæœºæ°´å¹³ä½ç½® (10% - 90%)
            const left = 10 + Math.random() * 80;
            bubble.style.left = left + '%';
            
            // åˆå§‹å‚ç›´ä½ç½® (å±å¹•åº•éƒ¨ä¸‹æ–¹)
            const startY = -100;
            bubble.dataset.y = startY;
            bubble.style.top = startY + 'px';
            
            // éšæœºå¤§å°
            const size = 60 + Math.random() * 40;
            bubble.style.width = size + 'px';
            bubble.style.height = size + 'px';

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ (Mobile compatible)
            bubble.addEventListener('pointerdown', (e) => handleBubbleClick(e, bubble, item));

            container.appendChild(bubble);
            state.bubbles.push(bubble);
        }

        function handleBubbleClick(e, bubble, item) {
            e.preventDefault(); // é˜²æ­¢åŒå‡»ç¼©æ”¾ç­‰
            
            if (item.id === state.targetItem.id) {
                // === ç‚¹å¯¹äº† ===
                state.score += 10 + (state.combo * 2);
                state.combo++;
                sfx.pop(state.combo);
                
                showPopEffect(e.clientX, e.clientY, "+"+(10 + state.combo * 2));
                removeBubble(bubble);
                updateUI();

                // ç´¯ç§¯ä¸€å®šåˆ†æ•°åï¼Œåˆ‡æ¢ç›®æ ‡
                if(state.combo % 5 === 0) { // æ¯è¿å‡»5æ¬¡æ¢ä¸ªç›®æ ‡
                     setNewTarget();
                }
            } else {
                // === ç‚¹é”™äº† ===
                state.lives--;
                state.combo = 0;
                sfx.wrong();
                
                bubble.style.background = 'rgba(255, 0, 0, 0.5)'; // å˜çº¢è­¦ç¤º
                showPopEffect(e.clientX, e.clientY, "âŒ");
                updateUI();

                if(state.lives <= 0) {
                    gameOver();
                }
            }
        }

        function removeBubble(bubble) {
            if(bubble.parentNode) bubble.parentNode.removeChild(bubble);
            state.bubbles = state.bubbles.filter(b => b !== bubble);
        }

        function showPopEffect(x, y, text) {
            const el = document.createElement('div');
            el.className = 'pop-effect';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            container.appendChild(el);
            setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el) }, 800);
        }

        function updateUI() {
            document.getElementById('score').innerText = state.score;
            document.getElementById('lives').innerText = state.lives;
        }

        function gameOver() {
            state.isPlaying = false;
            cancelAnimationFrame(state.gameLoopId);
            sfx.over();
            
            overlay.style.display = 'flex';
            menuCard.innerHTML = `
                <h1 style="color:var(--wrong-color)">Game Over</h1>
                <p>Final Score: ${state.score}</p>
                <button class="btn" onclick="startGame()">Try Again â”</button>
            `;
        }

    </script>
</body>
</html>